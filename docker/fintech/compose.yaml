# Thaliumx Fintech
# ================
# Ballerine (KYC/KYB workflow), BlinkFinance (placeholder)

services:
  # Ballerine PostgreSQL with plv8 extension
  ballerine-postgres:
    image: sibedge/postgres-plv8:15.3-3.1.7
    container_name: thaliumx-ballerine-postgres
    hostname: thaliumx-ballerine-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${BALLERINE_DB_USER:-ballerine}
      POSTGRES_PASSWORD: ${BALLERINE_DB_PASSWORD:?BALLERINE_DB_PASSWORD is required}
      POSTGRES_DB: ${BALLERINE_DB_NAME:-ballerine}
    ports:
      - "5433:5432"
    volumes:
      - ballerine_postgres_data:/var/lib/postgresql/data
    networks:
      - thaliumx-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ballerine -d ballerine"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Ballerine Workflow Service (Backend API)
  ballerine-workflow:
    image: ghcr.io/ballerine-io/workflows-service:latest
    container_name: thaliumx-ballerine-workflow
    hostname: thaliumx-ballerine-workflow
    restart: unless-stopped
    environment:
      # Vault configuration for secrets
      VAULT_ADDR: http://thaliumx-vault:8200
      VAULT_TOKEN: ${VAULT_TOKEN:-<VAULT_TOKEN>}
      VAULT_SECRET_PATH: kv/data/fintech/ballerine
      # Database configuration (DB_URL is built from Vault secrets in entrypoint)
      DB_USER: ballerine
      DB_HOST: thaliumx-ballerine-postgres
      DB_PORT: "5432"
      DB_NAME: ballerine
      # Non-secret configuration
      NODE_ENV: production
      LOG_LEVEL: info
      PORT: "3000"
      COMPOSE_PROJECT_NAME: thaliumx
      # Required Ballerine configuration
      ENVIRONMENT_NAME: production
      BACKOFFICE_CORS_ORIGIN: http://localhost:3004
      WORKFLOW_DASHBOARD_CORS_ORIGIN: http://localhost:3004
      HEADLESS_EXAMPLE_CORS_ORIGIN: http://localhost:3004
      KYB_EXAMPLE_CORS_ORIGIN: http://localhost:3004
      UNIFIED_API_URL: http://thaliumx-ballerine-workflow:3000
      APP_API_URL: http://localhost:3003
      # JWT configuration
      JWT_EXPIRATION: 1d
      # Mail adapter (use log for development)
      MAIL_ADAPTER: log
      # Hardcoded Ballerine configuration for production stability
      # Ballerine uses DB_URL for Prisma (not DATABASE_URL)
      DB_URL: postgresql://${BALLERINE_DB_USER:-ballerine}:${BALLERINE_DB_PASSWORD:?BALLERINE_DB_PASSWORD is required}@thaliumx-ballerine-postgres:5432/${BALLERINE_DB_NAME:-ballerine}
      DATABASE_URL: postgresql://${BALLERINE_DB_USER:-ballerine}:${BALLERINE_DB_PASSWORD:?BALLERINE_DB_PASSWORD is required}@thaliumx-ballerine-postgres:5432/${BALLERINE_DB_NAME:-ballerine}
      REDIS_URL: redis://thaliumx-redis:6379
      JWT_SECRET_KEY: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJiYWxsZXJpbmUifQ.signature
      SESSION_SECRET: ballerine-session-secret-production-key
      API_KEY: ballerine-api-key-production-secure
      # BCRYPT_SALT must be a valid bcrypt salt string (29 chars): $Vers$log2(NumRounds)$saltvalue
      # Generated with: bcrypt.genSaltSync(10) - must be exactly 29 characters
      BCRYPT_SALT: "$2b$10$.8CHAioRfbSk8KiRGNqNyu"
      # HASHING_KEY_SECRET must be a valid bcrypt salt - use base64 encoded version
      # Decoded: $2b$10$BTo0mwjVDZWpkq4sqQj3Ze
      HASHING_KEY_SECRET_BASE64: "JDJiJDEwJEJUbzBtd2pWRFpXcGtxNHNxUWozWmU="
      WEBHOOK_SECRET: ballerine-webhook-secret-production
      ENCRYPTION_KEY: ballerine-encryption-key-32bytes-production!
      WORKFLOW_TOKEN: ballerine-workflow-token-production
      COLLECTION_FLOW_TOKEN: ballerine-collection-flow-token-production
      NOTION_API_KEY: placeholder-notion-api-key
      MAGIC_LINK_JWT_SECRET: ballerine-magic-link-jwt-secret-production
      MAGIC_LINK_AUTH_JWT_SECRET: ballerine-magic-link-auth-jwt-secret-production
    # Disable Vault loading and use hardcoded environment variables
    # volumes:
    #   - ./scripts/ballerine-entrypoint.sh:/entrypoint.sh:ro
    #   - ./scripts/vault-secrets.js:/vault-secrets.js:ro
    # entrypoint: ["/bin/sh", "/entrypoint.sh"]
    command: ["dumb-init", "npm", "run", "prod"]
    ports:
      - "${BALLERINE_API_PORT:-3003}:3000"
    networks:
      - thaliumx-net
    depends_on:
      ballerine-postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "node", "-e", "const http = require('http'); http.get('http://localhost:3000/api/v1/_health/live', (res) => { process.exit(res.statusCode === 204 || res.statusCode === 200 ? 0 : 1); }).on('error', () => process.exit(1));"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s

  # Ballerine Backoffice (Admin UI)
  ballerine-backoffice:
    image: ghcr.io/ballerine-io/backoffice:latest
    container_name: thaliumx-ballerine-backoffice
    hostname: thaliumx-ballerine-backoffice
    restart: unless-stopped
    environment:
      VITE_API_URL: http://localhost:3003
      VITE_AUTH_ENABLED: "false"
    ports:
      - "${BALLERINE_BACKOFFICE_PORT:-3004}:80"
    networks:
      - thaliumx-net
    depends_on:
      ballerine-workflow:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "-O", "/dev/null", "http://127.0.0.1:80/"]
      interval: 10s
      timeout: 5s
      retries: 5

  # BlinkFinance (Blnk) - Open-source ledger for fintech
  # https://github.com/blnkfinance/blnk
  blinkfinance:
    build:
      context: ./blinkfinance
      dockerfile: Dockerfile
      args:
        BLNK_VERSION: v0.7.0
    image: thaliumx/blinkfinance:latest
    container_name: thaliumx-blinkfinance
    hostname: thaliumx-blinkfinance
    restart: unless-stopped
    environment:
      # Blnk configuration via environment variables
      TZ: UTC
      BLNK_SERVER_PORT: "5001"
      BLNK_DATA_SOURCE_DNS: postgres://${POSTGRES_USER:-thaliumx}:${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}@thaliumx-postgres:5432/${POSTGRES_DB:-thaliumx}?sslmode=disable
      BLNK_REDIS_DNS: thaliumx-redis:6379
      BLNK_TYPESENSE_DNS: http://thaliumx-typesense:8108
      BLNK_TYPESENSE_KEY: ${TYPESENSE_API_KEY:?TYPESENSE_API_KEY is required}
      BLNK_ENABLE_TELEMETRY: "false"
    ports:
      - "${BLINKFINANCE_PORT:-5001}:5001"
    volumes:
      - ./blinkfinance/blnk.json:/app/blnk.json:ro
      - blinkfinance_data:/app/data
    networks:
      - thaliumx-net
    depends_on:
      - ballerine-postgres
    healthcheck:
      test: ["CMD", "wget", "-q", "-O", "/dev/null", "http://localhost:5001/"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

volumes:
  ballerine_postgres_data:
    name: thaliumx-ballerine-postgres-data
  blinkfinance_data:
    name: thaliumx-blinkfinance-data

networks:
  thaliumx-net:
    external: true
