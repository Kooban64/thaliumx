# ThaliumX Production Alerting Rules
# Critical alerts for financial platform operations

groups:
  # ============================================
  # INFRASTRUCTURE ALERTS
  # ============================================
  - name: infrastructure
    rules:
      # Service Down Alerts
      - alert: ServiceDown
        expr: up == 0
        for: 1m
        labels:
          severity: critical
          category: infrastructure
        annotations:
          summary: "Service {{ $labels.job }} is down"
          description: "{{ $labels.job }} has been down for more than 1 minute."
          runbook_url: "https://docs.thaliumx.com/runbooks/service-down"

      - alert: HighCPUUsage
        expr: 100 - (avg by(instance) (rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 80
        for: 5m
        labels:
          severity: warning
          category: infrastructure
        annotations:
          summary: "High CPU usage on {{ $labels.instance }}"
          description: "CPU usage is above 80% for more than 5 minutes."

      - alert: CriticalCPUUsage
        expr: 100 - (avg by(instance) (rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 95
        for: 2m
        labels:
          severity: critical
          category: infrastructure
        annotations:
          summary: "Critical CPU usage on {{ $labels.instance }}"
          description: "CPU usage is above 95% for more than 2 minutes."

      - alert: HighMemoryUsage
        expr: (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100 > 85
        for: 5m
        labels:
          severity: warning
          category: infrastructure
        annotations:
          summary: "High memory usage on {{ $labels.instance }}"
          description: "Memory usage is above 85% for more than 5 minutes."

      - alert: DiskSpaceLow
        expr: (node_filesystem_avail_bytes{fstype!~"tmpfs|overlay"} / node_filesystem_size_bytes{fstype!~"tmpfs|overlay"}) * 100 < 15
        for: 5m
        labels:
          severity: warning
          category: infrastructure
        annotations:
          summary: "Low disk space on {{ $labels.instance }}"
          description: "Disk space is below 15% on {{ $labels.mountpoint }}."

      - alert: DiskSpaceCritical
        expr: (node_filesystem_avail_bytes{fstype!~"tmpfs|overlay"} / node_filesystem_size_bytes{fstype!~"tmpfs|overlay"}) * 100 < 5
        for: 2m
        labels:
          severity: critical
          category: infrastructure
        annotations:
          summary: "Critical disk space on {{ $labels.instance }}"
          description: "Disk space is below 5% on {{ $labels.mountpoint }}."

  # ============================================
  # DATABASE ALERTS
  # ============================================
  - name: database
    rules:
      - alert: PostgreSQLDown
        expr: pg_up == 0
        for: 1m
        labels:
          severity: critical
          category: database
        annotations:
          summary: "PostgreSQL is down"
          description: "PostgreSQL database is not responding."
          runbook_url: "https://docs.thaliumx.com/runbooks/postgres-down"

      - alert: PostgreSQLHighConnections
        expr: sum(pg_stat_activity_count) > 180
        for: 5m
        labels:
          severity: warning
          category: database
        annotations:
          summary: "High PostgreSQL connections"
          description: "PostgreSQL has more than 180 active connections."

      - alert: PostgreSQLSlowQueries
        expr: rate(pg_stat_statements_seconds_total[5m]) > 1
        for: 5m
        labels:
          severity: warning
          category: database
        annotations:
          summary: "Slow PostgreSQL queries detected"
          description: "Average query time is above 1 second."

      - alert: RedisDown
        expr: redis_up == 0
        for: 1m
        labels:
          severity: critical
          category: database
        annotations:
          summary: "Redis is down"
          description: "Redis cache is not responding."
          runbook_url: "https://docs.thaliumx.com/runbooks/redis-down"

      - alert: RedisHighMemory
        expr: redis_memory_used_bytes / redis_memory_max_bytes > 0.9
        for: 5m
        labels:
          severity: warning
          category: database
        annotations:
          summary: "Redis memory usage high"
          description: "Redis is using more than 90% of max memory."

      - alert: MongoDBDown
        expr: mongodb_up == 0
        for: 1m
        labels:
          severity: critical
          category: database
        annotations:
          summary: "MongoDB is down"
          description: "MongoDB is not responding."

  # ============================================
  # APPLICATION ALERTS
  # ============================================
  - name: application
    rules:
      - alert: BackendHighLatency
        expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket{job="thaliumx-backend"}[5m])) > 2
        for: 5m
        labels:
          severity: warning
          category: application
        annotations:
          summary: "High backend latency"
          description: "95th percentile latency is above 2 seconds."

      - alert: BackendHighErrorRate
        expr: rate(http_requests_total{job="thaliumx-backend",status=~"5.."}[5m]) / rate(http_requests_total{job="thaliumx-backend"}[5m]) > 0.05
        for: 5m
        labels:
          severity: warning
          category: application
        annotations:
          summary: "High error rate on backend"
          description: "Error rate is above 5%."

      - alert: BackendCriticalErrorRate
        expr: rate(http_requests_total{job="thaliumx-backend",status=~"5.."}[5m]) / rate(http_requests_total{job="thaliumx-backend"}[5m]) > 0.1
        for: 2m
        labels:
          severity: critical
          category: application
        annotations:
          summary: "Critical error rate on backend"
          description: "Error rate is above 10%."
          runbook_url: "https://docs.thaliumx.com/runbooks/high-error-rate"

      - alert: HighRequestRate
        expr: rate(http_requests_total{job="thaliumx-backend"}[1m]) > 1000
        for: 5m
        labels:
          severity: warning
          category: application
        annotations:
          summary: "High request rate"
          description: "Request rate is above 1000 req/min."

  # ============================================
  # SECURITY ALERTS
  # ============================================
  - name: security
    rules:
      - alert: VaultSealed
        expr: vault_core_unsealed == 0
        for: 1m
        labels:
          severity: critical
          category: security
        annotations:
          summary: "Vault is sealed"
          description: "HashiCorp Vault is sealed and secrets are inaccessible."
          runbook_url: "https://docs.thaliumx.com/runbooks/vault-sealed"

      - alert: VaultDown
        expr: up{job="vault"} == 0
        for: 1m
        labels:
          severity: critical
          category: security
        annotations:
          summary: "Vault is down"
          description: "HashiCorp Vault is not responding."

      - alert: HighAuthenticationFailures
        expr: rate(authentication_failures_total[5m]) > 10
        for: 5m
        labels:
          severity: warning
          category: security
        annotations:
          summary: "High authentication failure rate"
          description: "More than 10 authentication failures per minute."

      - alert: SuspiciousActivity
        expr: rate(security_threat_detected_total[5m]) > 0
        for: 1m
        labels:
          severity: warning
          category: security
        annotations:
          summary: "Suspicious activity detected"
          description: "Security threat detection triggered."

      - alert: RateLimitExceeded
        expr: rate(rate_limit_exceeded_total[5m]) > 100
        for: 5m
        labels:
          severity: warning
          category: security
        annotations:
          summary: "High rate limit violations"
          description: "More than 100 rate limit violations per minute."

      - alert: KeycloakDown
        expr: up{job="keycloak"} == 0
        for: 1m
        labels:
          severity: critical
          category: security
        annotations:
          summary: "Keycloak is down"
          description: "Keycloak authentication service is not responding."

  # ============================================
  # FINANCIAL ALERTS
  # ============================================
  - name: financial
    rules:
      - alert: HighTransactionVolume
        expr: rate(financial_transactions_total[5m]) > 100
        for: 5m
        labels:
          severity: info
          category: financial
        annotations:
          summary: "High transaction volume"
          description: "Transaction rate is above 100 per minute."

      - alert: TransactionFailures
        expr: rate(financial_transactions_failed_total[5m]) > 5
        for: 5m
        labels:
          severity: warning
          category: financial
        annotations:
          summary: "Transaction failures detected"
          description: "More than 5 transaction failures per minute."

      - alert: LargeTransaction
        expr: financial_transaction_amount > 100000
        for: 0m
        labels:
          severity: info
          category: financial
        annotations:
          summary: "Large transaction detected"
          description: "Transaction amount exceeds $100,000."

      - alert: ExchangeConnectionLost
        expr: exchange_connection_status == 0
        for: 2m
        labels:
          severity: critical
          category: financial
        annotations:
          summary: "Exchange connection lost"
          description: "Connection to {{ $labels.exchange }} has been lost."

      - alert: OrderBookStale
        expr: time() - orderbook_last_update_timestamp > 60
        for: 2m
        labels:
          severity: warning
          category: financial
        annotations:
          summary: "Order book data is stale"
          description: "Order book for {{ $labels.symbol }} hasn't been updated in 60 seconds."

  # ============================================
  # KAFKA ALERTS
  # ============================================
  - name: kafka
    rules:
      - alert: KafkaDown
        expr: up{job="kafka"} == 0
        for: 1m
        labels:
          severity: critical
          category: messaging
        annotations:
          summary: "Kafka is down"
          description: "Kafka broker is not responding."

      - alert: KafkaConsumerLag
        expr: kafka_consumer_group_lag > 10000
        for: 5m
        labels:
          severity: warning
          category: messaging
        annotations:
          summary: "High Kafka consumer lag"
          description: "Consumer group {{ $labels.group }} has lag of {{ $value }} messages."

      - alert: KafkaUnderReplicatedPartitions
        expr: kafka_server_replicamanager_underreplicatedpartitions > 0
        for: 5m
        labels:
          severity: warning
          category: messaging
        annotations:
          summary: "Kafka under-replicated partitions"
          description: "There are {{ $value }} under-replicated partitions."

  # ============================================
  # API GATEWAY ALERTS
  # ============================================
  - name: api-gateway
    rules:
      - alert: APIGatewayDown
        expr: up{job="apisix"} == 0
        for: 1m
        labels:
          severity: critical
          category: infrastructure
        annotations:
          summary: "APISIX API Gateway is down"
          description: "APISIX is not responding."

      - alert: APIGatewayHighLatency
        expr: histogram_quantile(0.95, rate(apisix_http_latency_bucket[5m])) > 1
        for: 5m
        labels:
          severity: warning
          category: infrastructure
        annotations:
          summary: "High API Gateway latency"
          description: "95th percentile latency is above 1 second."

      - alert: APIGatewayHighErrorRate
        expr: rate(apisix_http_status{code=~"5.."}[5m]) / rate(apisix_http_status[5m]) > 0.05
        for: 5m
        labels:
          severity: warning
          category: infrastructure
        annotations:
          summary: "High error rate at API Gateway"
          description: "Error rate is above 5%."