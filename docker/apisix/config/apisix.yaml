#
# APISIX Configuration for Thaliumx Platform
#

apisix:
  node_listen: 9080
  enable_ipv6: false
  enable_admin: true
  enable_http2: true
  
  # Allow admin access from Docker network
  allow_admin:
    - 0.0.0.0/0
  
  admin_listen:
    ip: 0.0.0.0
    port: 9180
  
  # Admin API key (stored in Vault: kv/thaliumx/gateway/apisix)
  admin_key:
    - name: admin
      key: ThaliumX2025AdminKey
      role: admin
    - name: viewer
      key: ThaliumX2025ViewerKey
      role: viewer

  # SSL configuration
  ssl:
    enable: true
    listen:
      - port: 9443

  # Proxy settings
  proxy_mode: http&stream
  stream_proxy:
    tcp:
      - 9100

# etcd configuration
deployment:
  role: traditional
  role_traditional:
    config_provider: etcd
  etcd:
    host:
      - "http://thaliumx-etcd:2379"
    prefix: /apisix
    timeout: 30

# Plugin configuration
plugins:
  - api-breaker
  - authz-keycloak
  - basic-auth
  - batch-requests
  - consumer-restriction
  - cors
  - echo
  - fault-injection
  - grpc-transcode
  - hmac-auth
  - http-logger
  - ip-restriction
  - jwt-auth
  - kafka-logger
  - key-auth
  - limit-conn
  - limit-count
  - limit-req
  - node-status
  - opa
  - openid-connect
  - prometheus
  - proxy-cache
  - proxy-mirror
  - proxy-rewrite
  - redirect
  - referer-restriction
  - request-id
  - request-validation
  - response-rewrite
  - serverless-post-function
  - serverless-pre-function
  - syslog
  - tcp-logger
  - traffic-split
  - ua-restriction
  - udp-logger
  - uri-blocker
  - zipkin

# Nginx configuration
nginx_config:
  error_log: /dev/stderr
  error_log_level: warn
  worker_processes: auto
  worker_rlimit_nofile: 20480
  
  event:
    worker_connections: 10620
  
  http:
    enable_access_log: true
    access_log: /dev/stdout
    access_log_format: '{"time": "$time_iso8601", "remote_addr": "$remote_addr", "request": "$request", "status": "$status", "body_bytes_sent": "$body_bytes_sent", "request_time": "$request_time", "upstream_response_time": "$upstream_response_time"}'
    access_log_format_escape: json
    
    keepalive_timeout: 60s
    client_header_timeout: 60s
    client_body_timeout: 60s
    send_timeout: 10s
    
    underscores_in_headers: "on"
    real_ip_header: X-Forwarded-For
    real_ip_recursive: "on"
    real_ip_from:
      - 127.0.0.1
      - "unix:"
      - 172.28.0.0/16

# Discovery configuration for service mesh
discovery:
  dns:
    servers:
      - "127.0.0.11:53"

# Prometheus metrics
plugin_attr:
  prometheus:
    export_uri: /apisix/prometheus/metrics
    export_addr:
      ip: 0.0.0.0
      port: 9091
    metric_prefix: apisix_