# Thaliumx Security
# =================
# Keycloak, Vault, OPA

services:
  keycloak:
    image: quay.io/keycloak/keycloak:24.0
    container_name: thaliumx-keycloak
    hostname: thaliumx-keycloak
    restart: unless-stopped
    # Development mode - for production, build an optimized image
    command: start-dev
    environment:
      KEYCLOAK_ADMIN: ${KEYCLOAK_ADMIN:-admin}
      KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD:?KEYCLOAK_ADMIN_PASSWORD is required}
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://thaliumx-postgres:5432/${POSTGRES_DB:-thaliumx}
      KC_DB_USERNAME: ${POSTGRES_USER:-thaliumx}
      KC_DB_PASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}
      KC_HEALTH_ENABLED: "true"
      KC_METRICS_ENABLED: "true"
      # Security settings
      KC_HOSTNAME_STRICT: "false"
      KC_HOSTNAME_STRICT_HTTPS: "false"
      KC_HTTP_ENABLED: "true"
      KC_PROXY: edge
      # Cache configuration
      KC_CACHE: local
    ports:
      - "${KEYCLOAK_PORT:-8080}:8080"
    volumes:
      - keycloak_data:/opt/keycloak/data
    networks:
      - thaliumx-net
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "exec 3<>/dev/tcp/localhost/8080 && echo -e 'GET /health/ready HTTP/1.1\\r\\nHost: localhost\\r\\nConnection: close\\r\\n\\r\\n' >&3 && cat <&3 | grep -q '200 OK'"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s

  vault:
    image: hashicorp/vault:1.15
    container_name: thaliumx-vault
    hostname: thaliumx-vault
    restart: unless-stopped
    cap_add:
      - IPC_LOCK
    environment:
      VAULT_DEV_ROOT_TOKEN_ID: ${VAULT_TOKEN:?VAULT_TOKEN is required}
      VAULT_DEV_LISTEN_ADDRESS: 0.0.0.0:8200
      VAULT_ADDR: http://127.0.0.1:8200
      VAULT_API_ADDR: http://thaliumx-vault:8200
      SKIP_SETCAP: "true"
    ports:
      - "${VAULT_PORT:-8200}:8200"
    volumes:
      - vault_data:/vault/data
      - vault_logs:/vault/logs
    # Dev mode for now - will enable TLS after basic functionality works
    command: server -dev
    networks:
      - thaliumx-net
    healthcheck:
      test: ["CMD-SHELL", "vault status --tls-skip-verify 2>/dev/null || exit 0"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # Vault initialization sidecar - runs once to set up secrets
  vault-init:
    image: hashicorp/vault:1.15
    container_name: thaliumx-vault-init
    hostname: thaliumx-vault-init
    restart: "no"
    environment:
      VAULT_ADDR: http://thaliumx-vault:8200
      VAULT_TOKEN: ${VAULT_TOKEN:?VAULT_TOKEN is required}

      # Values written into Vault (avoid hardcoded secrets)
      POSTGRES_DB: ${POSTGRES_DB:-thaliumx}
      POSTGRES_USER: ${POSTGRES_USER:-thaliumx}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}
      REDIS_PASSWORD: ${REDIS_PASSWORD:?REDIS_PASSWORD is required}
      BALLERINE_DB_PASSWORD: ${BALLERINE_DB_PASSWORD:?BALLERINE_DB_PASSWORD is required}
      JWT_SECRET: ${JWT_SECRET:?JWT_SECRET is required}
      ENCRYPTION_KEY: ${ENCRYPTION_KEY:?ENCRYPTION_KEY is required}
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        echo "Waiting for Vault to be ready..."
        until vault status > /dev/null 2>&1; do
          sleep 2
        done
        echo "Vault is ready. Running initialization..."
        
        # Enable KV secrets engine if not already enabled
        if ! vault secrets list | grep -q "^kv/"; then
          echo "Enabling KV secrets engine..."
          vault secrets enable -path=kv kv-v2
        else
          echo "KV secrets engine already enabled"
        fi
        
        # Create secrets for Ballerine (with correct keys for vault-secrets.js)
        echo "Creating Ballerine secrets..."
        vault kv put kv/fintech/ballerine \
          db_password="$BALLERINE_DB_PASSWORD" \
          session_secret="ballerine-session-secret-key-production" \
          api_key="ballerine-api-key-for-production" \
          hashing_key_secret="ballerine-hashing-key-secret" \
          webhook_secret="ballerine-webhook-secret" \
          jwt_secret_key="ballerine-jwt-secret-key" \
          magic_link_jwt_secret="ballerine-magic-link-jwt-secret" \
          magic_link_auth_jwt_secret="ballerine-magic-link-auth-jwt-secret" \
          notion_api_key="ballerine-notion-api-key"
        
        # Create secrets for Backend
        echo "Creating Backend secrets..."
        vault kv put kv/fintech/backend \
          DATABASE_URL="postgresql://$POSTGRES_USER:$POSTGRES_PASSWORD@thaliumx-postgres:5432/$POSTGRES_DB" \
          REDIS_URL="redis://:$REDIS_PASSWORD@thaliumx-redis:6379" \
          JWT_SECRET="$JWT_SECRET" \
          ENCRYPTION_KEY="$ENCRYPTION_KEY"
        
        # Create secrets for BlinkFinance
        echo "Creating BlinkFinance secrets..."
        vault kv put kv/fintech/blinkfinance \
          api_key="blinkfinance-api-key" \
          secret_key="blinkfinance-secret-key"
        
        echo "Vault initialization complete!"
    networks:
      - thaliumx-net
    depends_on:
      vault:
        condition: service_healthy

  opa:
    image: openpolicyagent/opa:0.64.0
    container_name: thaliumx-opa
    hostname: thaliumx-opa
    restart: unless-stopped
    command:
      - "run"
      - "--server"
      - "--addr=0.0.0.0:8181"
      - "--log-level=info"
    ports:
      - "8181:8181"
    volumes:
      - ./policies:/policies:ro
    networks:
      - thaliumx-net
    healthcheck:
      test: ["CMD", "/opa", "eval", "true"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  keycloak_data:
    name: thaliumx-keycloak-data
  vault_data:
    name: thaliumx-vault-data
  vault_logs:
    name: thaliumx-vault-logs

networks:
  thaliumx-net:
    external: true
